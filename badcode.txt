#include <curses.h>
#include <sys/ioctl.h>
#include <unistd.h>
#include "main.h"
#include <pthread.h>

pthread_t jumpThread;
pthread_mutex_t screenMutex = PTHREAD_MUTEX_INITIALIZER;

volatile int marioX, marioY;

int checkTop(int xIn, int yIn){
    int x = xIn;
    int y = yIn;
    if ((PAIR_NUMBER(mvinch(y, x+6))    == COLOR_PAIR_BABYBLUE) &&
        (PAIR_NUMBER(mvinch(y, x+12))   == COLOR_PAIR_BABYBLUE) &&
        (PAIR_NUMBER(mvinch(y+1, x+4))  == COLOR_PAIR_BABYBLUE) &&
        (PAIR_NUMBER(mvinch(y+1, x+18)) == COLOR_PAIR_BABYBLUE)){
        return 1;
    }
    return 0;
}
int checkBottom(int xIn, int yIn){
    int x = xIn;
    int y = yIn;
    if ((PAIR_NUMBER(mvinch(y+16, x+6))  == COLOR_PAIR_BABYBLUE) && (PAIR_NUMBER(mvinch(y+16, x+12)) == COLOR_PAIR_BABYBLUE)){
        return 1;
    }
    return 0;
}
void* jumpThreadFunction(void* arg){
    int iTwo = 0;
    for(int i = 0; i < 30; i++){

        
        if(checkTop(marioX, marioY-1)){
            pthread_mutex_lock(&screenMutex);
            deleteMarioSide(marioX, marioY);
       for(int i = iTwo; i > 0; i--){
        
        if(checkBottom(marioX, marioY+1)){
            pthread_mutex_lock(&screenMutex);
            deleteMarioSide(marioX, marioY);
            marioY++;
            printMarioSide(marioX, marioY);
        }
        pthread_mutex_unlock(&screenMutex);
        refresh();
        usleep(10000);
    }
    return NULL;
}

void right(){
    pthread_mutex_lock(&screenMutex);
    deleteMarioSide(marioX, marioY);
    marioX+=2;
    printMarioSide(marioX, marioY);
    pthread_mutex_unlock(&screenMutex);
}

int main(){
    int width;
    int height;
    struct winsize wbuf;
    if(ioctl(0, TIOCGWINSZ, &wbuf) != - 1){
        width = wbuf.ws_col;
        height = wbuf.ws_row;
    }

    // 1 time calls
    initscr();
    cbreak();
    noecho();
    keypad(stdscr, TRUE);
    initializeColors();
    
    clear();
    marioX = width/8;
    marioY = (height*3)/4;
    printMarioSide(marioX, marioY);
    refresh();
    printTitle();
    printMarioSide(marioX, marioY);

    int startMenuToggle = 1;
    while(startMenuToggle){
        int ch = getch();
        switch(ch){
            case 'w': pthread_create(&jumpThread, NULL, jumpThreadFunction, NULL); break;
            case 'a': ; break;
            case 's': ; break;
            case 'd': right(); break;
            case 'q':startMenuToggle = 0; break;
        }
    }

    //Game Code!

    
    //End Of Program
    endwin();
    return 1;
}      marioY--;
            printMarioSide(marioX, marioY);
            iTwo++;
        }
        pthread_mutex_unlock(&screenMutex);
        refresh();
        usleep(10000);
    }
       